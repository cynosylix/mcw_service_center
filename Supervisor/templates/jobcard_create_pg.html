{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCW CRM - Create Job Card</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #4e73df;
            --dark-color: #5a5c69;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, var(--primary-color) 0%, #224abe 100%);
            color: white;
            transition: all 0.3s;
            z-index: 1000;
        }

        .sidebar-brand {
            height: 4.375rem;
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 800;
            padding: 1.5rem 1rem;
            text-align: center;
            letter-spacing: 0.05rem;
        }

        .sidebar-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            margin: 0 1rem 1rem;
        }

        .sidebar-heading {
            padding: 0 1rem;
            font-weight: 800;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: rgba(0, 0, 0, 0.8);
            padding: 0.75rem 1rem;
            font-weight: 600;
        }

        .nav-link:hover {
            color: rgb(204, 14, 14);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link i {
            margin-right: 0.5rem;
        }

        .nav-link.active {
            color: rgb(0, 0, 0);
            font-weight: 700;
        }


        /* Main Content */
        #content {
            width: calc(100% - var(--sidebar-width));
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: all 0.3s;
        }

        /* Topbar */
        .topbar {
            height: 4.375rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            background-color: white;
        }

        /* Form Styles */
        .form-section {
            background-color: white;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .form-section-header {
            border-bottom: 1px solid #e3e6f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                margin-left: -250px;
            }

            #content {
                width: 100%;
                margin-left: 0;
            }

            .sidebar.toggled {
                margin-left: 0;
            }

            #content.toggled {
                margin-left: 250px;
            }
        }
        
    </style>
</head>

<body id="page-top">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
            <img src="{% static 'img/logo.png' %}" alt="MCW" height="50" class="me-2">
            <span>MCW CRM</span>
        </a>

        <hr class="sidebar-divider">

        <div class="sidebar-heading">Core</div>

<<<<<<< HEAD
        <li class="nav-item">
             <a class="nav-link active"  href="/Supervisor/Supervisor_home">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
        </li>
        <!-- 
        <li class="nav-item">
=======
        <!-- <li class="nav-item">
            <a class="nav-link active" href="#">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
        </li> -->

        <!-- <li class="nav-item">
>>>>>>> sakrish
            <a class="nav-link" href="#">
                <i class="bi bi-people"></i>
                <span>Customers</span>
            </a>
        </li> -->

        <li class="nav-item">
            <a class="nav-link" href="/Supervisor/Supervisor_jobcard">
                <i class="bi bi-briefcase"></i>
                <span>Job Card</span>
            </a>
        </li>

        <hr class="sidebar-divider">

        <div class="sidebar-heading">Management</div>

        <!-- <li class="nav-item">
            <a class="nav-link" href="#">
                <i class="bi bi-file-earmark-text"></i>
                <span>Staff</span>
            </a>
        </li> -->

        <li class="nav-item">
            <a class="nav-link" href="/Supervisor/supervisor_view_stock">
        <!-- <li class="nav-item">
            <a class="nav-link" href="#">
                <i class="bi bi-box-seam"></i>
                <span>Stock</span>
            </a>
        </li> -->
        <li class="nav-item">
            <a class="nav-link" href="/Supervisor/supervisor_Attendance">
                <i class="bi bi-people"></i>
                <span>Attendance</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/Supervisor/profile">
                <i class="bi bi-file-earmark-text"></i>
                <span>Profile</span>
            </a>
        </li>
          <li class="nav-item">
            <a class="nav-link" href="/Supervisor/supervisor_view_staff_attendance">
                <i class="bi bi-box-seam"></i>
                <span>Attendance</span>
            </a>
        </li>

        <!-- <li class="nav-item">
            <a class="nav-link" href="#">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </li> -->
    </div>

    <!-- Content Wrapper -->
    <div id="content">
        <!-- Topbar -->
        <nav class="topbar navbar navbar-expand navbar-light shadow">
            <!-- Sidebar Toggle -->
            <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>

            <!-- Topbar Navbar -->
            <ul class="navbar-nav ms-auto">
                <!-- Notifications Dropdown -->
                <!-- <li class="nav-item dropdown no-arrow mx-1">
                    <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button"
                        data-bs-toggle="dropdown">
                        <i class="bi bi-bell-fill"></i>
                        <span class="badge bg-danger badge-counter">3+</span>
                    </a>
                    <div class="dropdown-list dropdown-menu dropdown-menu-end shadow">
                        <h6 class="dropdown-header">Alerts Center</h6>
                        <a class="dropdown-item d-flex align-items-center" href="#">
                            <div class="me-3">
                                <div class="icon-circle bg-primary">
                                    <i class="bi bi-file-earmark-text text-white"></i>
                                </div>
                            </div>
                            <div>
                                <div class="small text-gray-500">December 12, 2023</div>
                                <span class="font-weight-bold">A new monthly report is ready to download!</span>
                            </div>
                        </a>
                        <a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                    </div>
                </li> -->

                <!-- User Dropdown -->
                <li class="nav-item dropdown no-arrow">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                        data-bs-toggle="dropdown">
                        <span class="me-2 d-none d-lg-inline text-gray-600 small" id="user_name">xxxxx</span>
                        <img class="img-profile rounded-circle" src="{% static 'img/logo.png' %}" height="40px">
                    </a>
                    <div class="dropdown-menu dropdown-menu-end shadow">
                        <a class="dropdown-item" href="/Supervisor/profile">
                            <i class="bi bi-person-fill me-2"></i>
                            Profile
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="bi bi-gear-fill me-2"></i>
                            Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Logout
                        </a>
                    </div>
                </li>
            </ul>
        </nav>
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid p-4">
            <!-- Page Heading -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">Create New Job Card</h1>
                <div>
                    <!-- <a href="/JobCardpg" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a> -->
                </div>
            </div>

            <!-- Job Card Form -->
            <form id="jobCardForm" method="post" action="{% url 'create_job_card' %}">
                {% csrf_token %}
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Customer & Vehicle Information -->
                        <!-- Customer & Vehicle Information -->
                        <div class="form-section">
                            <h5 class="form-section-header">
                                <i class="bi bi-person-badge me-2"></i>Customer & Vehicle Information
                            </h5>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">Customer Name*</label>
                                        <input type="text" class="form-control" id="customerName" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="customerPhone" class="form-label">Phone Number*</label>
                                        <input type="tel" class="form-control" id="customerPhone" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="customerEmail" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="customerEmail">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerAddress" class="form-label">Address</label>
                                        <textarea class="form-control" id="customerAddress" rows="3"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label for="customerNotes" class="form-label">Customer Notes</label>
                                        <textarea class="form-control" id="customerNotes" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="vehicleReg" class="form-label">Vehicle Registration No*</label>
                                        <input type="text" class="form-control" id="vehicleReg" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="vehicleModel" class="form-label">Vehicle Model*</label>
                                        <input type="text" class="form-control" id="vehicleModel" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="vehicleMake" class="form-label">Vehicle Make</label>
                                        <input type="text" class="form-control" id="vehicleMake">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="chassisNo" class="form-label">Chassis No</label>
                                        <input type="text" class="form-control" id="chassisNo">
                                    </div>

                                    <div class="mb-3">
                                        <label for="engineNo" class="form-label">Engine No</label>
                                        <input type="text" class="form-control" id="engineNo">
                                    </div>

                                    <div class="mb-3">
                                        <label for="petrolLevel" class="form-label">Petrol Level</label>
                                        <input type="text" class="form-control" id="petrolLevel">

                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="vehicleNotes" class="form-label">Vehicle Notes/Issues</label>
                                <textarea class="form-control" id="vehicleNotes" rows="4"></textarea>
                            </div>
                        </div>

                        <!-- Job Details -->
                        <div class="form-section">
                            <h5 class="form-section-header">
                                <i class="bi bi-clipboard-check me-2"></i>Job Details
                            </h5>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="jobType" class="form-label">Job Type</label>
                                        <select class="form-select" id="jobType" required>
                                            <option value="" selected disabled>Select job type...</option>
                                            <option value="Service">Service</option>
                                            <option value="Repair">Repair</option>
                                            <option value="Inspection">Inspection</option>
                                            <option value="Custom">Custom Work</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="receivedDate" class="form-label">Received Date</label>
                                        <input type="date" class="form-control" id="receivedDate" required>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deliveryDate" class="form-label">Expected Delivery Date</label>
                                        <input type="date" class="form-control" id="deliveryDate" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="assignedStaff" class="form-label">Assigned Staff</label>
                                        <select class="form-select" id="assignedStaff" required>
                                            <option value="" selected disabled>Select staff...</option>

                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="workDescription" class="form-label">Work Description</label>
                                <textarea class="form-control" id="workDescription" rows="4" required></textarea>
                                <div class="form-text">Enter each task on a new line or separate with commas</div>
                            </div>

                            <div class="mb-3">
                                <label for="jobStatus" class="form-label">Job Status</label>
                                <select class="form-select" id="jobStatus" required>
                                    <option value="Pending" selected>Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Parts & Materials -->
                        <!-- Parts & Materials -->
                        <div class="form-section">
                            <h5 class="form-section-header">
                                <i class="bi bi-box-seam me-2"></i>Parts & Materials
                            </h5>

                            <div id="partsContainer">
                                <!-- Parts will be added here dynamically -->
                                <div class="part-item mb-3 border-bottom pb-3">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label">Part Name</label>
                                            <div class="dropdown">
                                                <input type="text" class="form-control part-search"
                                                    placeholder="Search parts..." data-bs-toggle="dropdown"
                                                    aria-expanded="false">
                                                <ul class="dropdown-menu part-dropdown w-100">
                                                    <!-- Parts will be populated here from JavaScript -->
                                                </ul>
                                            </div>
                                            <input type="hidden" class="part-id" name="partId[]">
                                        </div>
                                        <div class="col-3">
                                            <label class="form-label">Qty</label>
                                            <input type="number" class="form-control" name="partQty[]" min="1"
                                                value="1">
                                        </div>
                                        <div class="col-2">
                                            <label class="form-label">Price</label>
                                            <input type="number" step="0.01" class="form-control part-price"
                                                name="partPrice[]" readonly>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-primary" id="addPartBtn">
                                <i class="bi bi-plus"></i> Add Part
                            </button>

                            <div class="mt-3 pt-2 border-top">
                                <div class="d-flex justify-content-between">
                                    <strong>Total Parts Cost:</strong>
                                    <span id="partsTotal">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Labor & Pricing -->
                        <div class="form-section">
                            <h5 class="form-section-header">
                                <i class="bi bi-cash-stack me-2"></i>Labor & Pricing
                            </h5>

                            <div class="mb-3">
                                <label for="laborHours" class="form-label">Labor Hours</label>
                                <input type="number" step="0.5" class="form-control" id="laborHours" value="1">
                            </div>

                            <div class="mb-3">
                                <label for="hourlyRate" class="form-label">Hourly Rate</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" class="form-control" id="hourlyRate" value="50.00">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="discount" class="form-label">Discount</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="discount" value="0.00">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>

                            <div class="border-top pt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Parts Total:</span>
                                    <span id="partsSubtotal">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Labor Cost:</span>
                                    <span id="laborCost">$50.00</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Estimated Total:</span>
                                    <span id="estimatedTotal">$50.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-section">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Job Card
                                </button>
                                <!-- <button type="button" class="btn btn-outline-secondary">
                                    <i class="bi bi-printer"></i> Save & Print
                                </button> -->
                                <button type="reset" class="btn btn-outline-danger">
                                    <i class="bi bi-x-circle"></i> Reset Form
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- End of Page Content -->
    </div>
    <!-- End of Content Wrapper -->

    <!-- New Customer Modal -->


    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ready to Leave?</h5>
                    <button class="close" type="button" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                    <a class="btn btn-primary" href="/Spare_Purchase/logout">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom scripts -->
    <script>
        const appData = JSON.parse('{{ data|escapejs }}');
        console.log(appData.user_name);
        const couser_name=document.getElementById('user_name')
        couser_name.textContent =appData.user_name
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Populate staff dropdown
            const staffDropdown = document.getElementById('assignedStaff');
            while (staffDropdown.options.length > 1) {
                staffDropdown.remove(1);
            }
            appData.worker.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.name} (${worker.position})`;
                staffDropdown.appendChild(option);
            });

            // Initialize parts functionality
            initParts();

            // Initialize the first part row that's already in the HTML
            const firstPartRow = document.querySelector('.part-item');
            if (firstPartRow) {
                initPartSearch(firstPartRow);
            }
        });

        // Parts functionality
        function initParts() {
            // Add event listener for adding new parts
            document.getElementById('addPartBtn').addEventListener('click', addPartRow);
        }

        function addPartRow() {
            const partsContainer = document.getElementById('partsContainer');
            const newPartDiv = document.createElement('div');
            newPartDiv.className = 'part-item mb-3 border-bottom pb-3';
            newPartDiv.innerHTML = `
            <div class="row g-2">
                <div class="col-6">
                    <div class="dropdown">
                        <input type="text" class="form-control part-search" placeholder="Search parts..." 
                               data-bs-toggle="dropdown" aria-expanded="false">
                        <ul class="dropdown-menu part-dropdown w-100">
                            <!-- Parts will be populated here from JavaScript -->
                        </ul>
                    </div>
                    <input type="hidden" class="part-id" name="partId[]">
                </div>
                <div class="col-3">
                    <input type="number" class="form-control" name="partQty[]" min="1" value="1">
                </div>
                <div class="col-2">
                    <input type="number" step="0.01" class="form-control part-price" name="partPrice[]" readonly>
                </div>
                <div class="col-1">
                    <button type="button" class="btn btn-sm btn-outline-danger w-100 remove-part mt-1">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
            partsContainer.appendChild(newPartDiv);

            // Initialize search functionality for this part
            initPartSearch(newPartDiv);

            // Add event listener to the remove button
            newPartDiv.querySelector('.remove-part').addEventListener('click', function () {
                partsContainer.removeChild(newPartDiv);
                calculateTotals();
            });
        }

        function initPartSearch(partDiv) {
            const searchInput = partDiv.querySelector('.part-search');
            const dropdownMenu = partDiv.querySelector('.part-dropdown');
            const partIdInput = partDiv.querySelector('.part-id');
            const priceInput = partDiv.querySelector('.part-price');

            // Populate dropdown with parts data
            function populateDropdown(filter = '') {
                dropdownMenu.innerHTML = '';
                const filteredParts = appData.stock.filter(part =>
                    part.name.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredParts.length === 0) {
                    const item = document.createElement('li');
                    item.innerHTML = '<span class="dropdown-item">No parts found</span>';
                    dropdownMenu.appendChild(item);
                    return;
                }

                filteredParts.forEach(part => {
                    const item = document.createElement('li');
                    item.innerHTML = `
                    <a class="dropdown-item" href="#" data-id="${part.id}" data-price="${part.price}">
                        ${part.name} (${part.quantity} available) - $${part.price}
                    </a>
                `;
                    dropdownMenu.appendChild(item);
                });

                // Add click handlers for dropdown items
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', function (e) {
                        e.preventDefault();
                        const part = appData.stock.find(p => p.id == this.dataset.id);
                        if (part) {
                            searchInput.value = part.name;
                            partIdInput.value = part.id;
                            priceInput.value = part.price;
                            calculateTotals();
                        }
                        // Hide dropdown after selection
                        const dropdown = bootstrap.Dropdown.getInstance(searchInput);
                        dropdown.hide();
                    });
                });
            }

            // Initial population
            populateDropdown();

            // Search functionality
            searchInput.addEventListener('input', function () {
                populateDropdown(this.value);
                // Show dropdown when typing
                const dropdown = new bootstrap.Dropdown(searchInput);
                dropdown.show();
            });

            // Clear selection when input is cleared
            searchInput.addEventListener('change', function () {
                if (!this.value) {
                    partIdInput.value = '';
                    priceInput.value = '';
                    calculateTotals();
                }
            });
        }

        // Rest of your existing JavaScript...
        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('sidebar').classList.toggle('toggled');
            document.getElementById('content').classList.toggle('toggled');
        });

        // Calculate totals function
        function calculateTotals() {
            // Calculate parts total
            let partsTotal = 0;
            document.querySelectorAll('.part-item').forEach(item => {
                const qty = parseFloat(item.querySelector('[name="partQty[]"]').value) || 0;
                const price = parseFloat(item.querySelector('.part-price').value) || 0;
                partsTotal += qty * price;
            });

            // Calculate labor cost
            const laborHours = parseFloat(document.getElementById('laborHours').value) || 0;
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const laborCost = laborHours * hourlyRate;

            // Calculate discount
            const discount = parseFloat(document.getElementById('discount').value) || 0;

            // Update display
            document.getElementById('partsTotal').textContent = '$' + partsTotal.toFixed(2);
            document.getElementById('partsSubtotal').textContent = '$' + partsTotal.toFixed(2);
            document.getElementById('laborCost').textContent = '$' + laborCost.toFixed(2);

            // Calculate and display estimated total
            const subtotal = partsTotal + laborCost;
            const discountAmount = subtotal * (discount / 100);
            const estimatedTotal = subtotal - discountAmount;
            document.getElementById('estimatedTotal').textContent = '$' + estimatedTotal.toFixed(2);
        }

        // Add event listeners for calculation
        document.getElementById('laborHours').addEventListener('input', calculateTotals);
        document.getElementById('hourlyRate').addEventListener('input', calculateTotals);
        document.getElementById('discount').addEventListener('input', calculateTotals);

        // Delegate events for dynamic part inputs
        document.getElementById('partsContainer').addEventListener('input', function (e) {
            if (e.target.name === 'partQty[]' || e.target.classList.contains('part-search')) {
                calculateTotals();
            }
        });

        // Initialize calculations
        calculateTotals();




        // Add this to your existing JavaScript code

        document.getElementById('jobCardForm').addEventListener('submit', function (e) {
            e.preventDefault();
            
             // Calculate the estimated total first
            calculateTotals(); 
            // Collect all form data
            const formData = {
                customer: {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value,
                    notes: document.getElementById('customerNotes').value
                },
                vehicle: {
                    registration: document.getElementById('vehicleReg').value,
                    model: document.getElementById('vehicleModel').value,
                    make: document.getElementById('vehicleMake').value,
                    chassis_no: document.getElementById('chassisNo').value,
                    engine_no: document.getElementById('engineNo').value,
                    petrol_level: document.getElementById('petrolLevel').value,
                    notes: document.getElementById('vehicleNotes').value
                },
                job: {
                    type: document.getElementById('jobType').value,
                    received_date: document.getElementById('receivedDate').value,
                    delivery_date: document.getElementById('deliveryDate').value,
                    assigned_staff: document.getElementById('assignedStaff').value,
                    description: document.getElementById('workDescription').value,
                    status: document.getElementById('jobStatus').value,
                    labor_hours: document.getElementById('laborHours').value,
                    hourly_rate: document.getElementById('hourlyRate').value,
                    discount: document.getElementById('discount').value,
                    estimated_total: parseFloat(document.getElementById('estimatedTotal').textContent.replace('$', '')) 
                    
                },
                parts: []
            };

            // Collect parts data
            document.querySelectorAll('.part-item').forEach(item => {
                const partId = item.querySelector('.part-id').value;
                const quantity = item.querySelector('[name="partQty[]"]').value;
                const price = item.querySelector('.part-price').value;

                if (partId) {
                    formData.parts.push({
                        id: partId,
                        quantity: quantity,
                        price: price
                    });
                }
            });

            // Send data to backend
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // alert('Job card created successfully!');
                        // Redirect or clear form as needed
                        window.location.href = '/Supervisor/Supervisor_jobcard';
                        
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error occurred'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while saving the job card.');
                });
        });
    </script>
</body>

</html>