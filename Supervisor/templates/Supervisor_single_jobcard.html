{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCW CRM - Job Card Details</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #4e73df;
            --dark-color: #5a5c69;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, var(--primary-color) 0%, #224abe 100%);
            color: white;
            transition: all 0.3s;
            z-index: 1000;
        }

        .sidebar-brand {
            height: 4.375rem;
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 800;
            padding: 1.5rem 1rem;
            text-align: center;
            letter-spacing: 0.05rem;
        }

        .sidebar-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            margin: 0 1rem 1rem;
        }

        .sidebar-heading {
            padding: 0 1rem;
            font-weight: 800;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: rgba(0, 0, 0, 0.8);
            padding: 0.75rem 1rem;
            font-weight: 600;
        }

        .nav-link:hover {
            color: rgb(204, 14, 14);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link i {
            margin-right: 0.5rem;
        }

        .nav-link.active {
            color: rgb(0, 0, 0);
            font-weight: 700;
        }

        /* Main Content */
        #content {
            width: calc(100% - var(--sidebar-width));
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: all 0.3s;
        }

        /* Topbar */
        .topbar {
            height: 4.375rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            background-color: white;
        }

        /* Form Styles */
        .form-section {
            background-color: white;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .form-section-header {
            border-bottom: 1px solid #e3e6f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        /* Status Badges */
        .badge-Completed {
            background-color: #02f30e;
        }

        .badge-in_progress {
            background-color: #e0d319;
        }

        .badge-pending {
            background-color: #e01919;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                margin-left: -250px;
            }

            #content {
                width: 100%;
                margin-left: 0;
            }

            .sidebar.toggled {
                margin-left: 0;
            }

            #content.toggled {
                margin-left: 250px;
            }
        }
    </style>
</head>

<body id="page-top">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
            <img src="{% static 'img/logo.png' %}" alt="MCW" height="50" class="me-2">
            <span>MCW CRM</span>
        </a>

        <hr class="sidebar-divider">

        <div class="sidebar-heading">Core</div>

        <li class="nav-item">
            <a class="nav-link" href="#">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link active" href="/Supervisor/Supervisor_jobcard">
                <i class="bi bi-briefcase"></i>
                <span>Job Card</span>
            </a>
        </li>

        <hr class="sidebar-divider">

        <div class="sidebar-heading">Management</div>

        <li class="nav-item">
            <a class="nav-link" href="#">
                <i class="bi bi-box-seam"></i>
                <span>Stock</span>
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="#">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </li>
    </div>

    <!-- Content Wrapper -->
    <div id="content">
        <!-- Topbar -->
        <nav class="topbar navbar navbar-expand navbar-light shadow">
            <!-- Sidebar Toggle -->
            <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>

            <!-- Topbar Navbar -->
            <ul class="navbar-nav ms-auto">
                <!-- User Dropdown -->
                <li class="nav-item dropdown no-arrow">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                        data-bs-toggle="dropdown">
                        <span class="me-2 d-none d-lg-inline text-gray-600 small">{{name}}</span>
                        <img class="img-profile rounded-circle" src="{% static 'img/logo.png' %}" height="40px">
                    </a>
                    <div class="dropdown-menu dropdown-menu-end shadow">
                        <a class="dropdown-item" href="#">
                            <i class="bi bi-person-fill me-2"></i>
                            Profile
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="bi bi-gear-fill me-2"></i>
                            Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Logout
                        </a>
                    </div>
                </li>
            </ul>
        </nav>
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid p-4">
            <!-- Page Heading -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">Job Card Details</h1>
                <div>
                    <a href="#" class="btn btn-primary">
                        <i class="bi bi-pencil-square"></i> Edit Job Card
                    </a>
                    <!-- <a href="/Supervisor/Supervisor_jobcard" class="btn btn-outline-secondary ms-2">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a> -->
                </div>
            </div>

            <!-- Job Card Details -->
            <div class="row">
                <div class="col-lg-8">
                    <!-- Customer & Vehicle Information -->
                    <div class="form-section">
                        <h5 class="form-section-header">
                            <i class="bi bi-person-badge me-2"></i>Customer & Vehicle Information
                        </h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Customer Name :- {{JobCardDBdata.customer.name}}</label>
                                    <!-- <p class="form-control-plaintext">{{JobCardDBdata.customer.name}}</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Registration No :-
                                        {{JobCardDBdata.vehicle.registration_no}}</label>
                                    <!-- <p class="form-control-plaintext">{{JobCardDBdata.vehicle.registration_no}}</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Vehicle Model :- {{JobCardDBdata.vehicle.model}}</label>
                                    <!-- <p class="form-control-plaintext">{{JobCardDBdata.vehicle.model}}</p> -->
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Chassis No :- {{JobCardDBdata.vehicle.chassis_no}}</label>
                                    <!-- <p class="form-control-plaintext">{{JobCardDBdata.vehicle.chassis_no}}</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Engine No :- {{JobCardDBdata.vehicle.engine_no}}</label>
                                    <!-- <p class="form-control-plaintext">{{JobCardDBdata.vehicle.engine_no}}</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Petrol Level :-
                                        {{JobCardDBdata.vehicle.petrol_level}}</label>
                                    <!-- <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 25%;"
                                            aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">1/4 Tank</div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer Notes</label>
                            <div class="border p-3 bg-light">
                                <p>{{JobCardDBdata.customer.customernotes}}</p>
                                <!-- <ul>
                                    <li>Engine oil change</li>
                                    <li>Oil filter replacement</li>
                                    <li>Brake inspection and adjustment</li>
                                    <li>Wheel alignment</li>
                                    <li>AC system check</li>
                                </ul> -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vehicle Notes/Issues</label>
                            <div class="border p-3 bg-light">
                                <p>{{JobCardDBdata.vehicle.notes}}</p>
                                <!-- <ul>
                                    <li>Engine oil change</li>
                                    <li>Oil filter replacement</li>
                                    <li>Brake inspection and adjustment</li>
                                    <li>Wheel alignment</li>
                                    <li>AC system check</li>
                                </ul> -->
                            </div>
                        </div>
                    </div>

                    <!-- Job Details -->
                    <div class="form-section">
                        <h5 class="form-section-header">
                            <i class="bi bi-clipboard-check me-2"></i>Job Details
                        </h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Job Card No :- {{JobCardDBdata.id}}</label>
                                    <!-- <p class="form-control-plaintext">JC-2023-105</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Received Date :- {{JobCardDBdata.received_date}}</label>
                                    <!-- <p class="form-control-plaintext">March 5, 2023</p> -->
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Delivery Date :-</label>
                                    <span class="badge bg-warning text-danger font-weight-bold">
                                        {{JobCardDBdata.delivery_date}}</span>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Paid :-</label>
                                    <span class="badge bg-warning text-danger font-weight-bold">
                                        {{JobCardDBdata.paydPayent}}</span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assigned Staff :- {{JobCardDBdata.assigned_staff.name}}
                                        ({{JobCardDBdata.assigned_staff.position}})</label>
                                    <!-- <p class="form-control-plaintext">Michael Johnson (Senior Technician)</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Job Status :- </label>
                                    <span class="badge bg-warning text-dark">{{JobCardDBdata.status}}</span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Estimated Amount :- ₹
                                        {{JobCardDBdata.TotalPayent}}</label>
                                    <!-- <p class="form-control-plaintext font-weight-bold">{{JobCardDBdata.TotalPayent}}</p> -->
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Pyment Status :- </label>
                                    <span class="badge bg-warning text-dark">{{JobCardDBdata.paymentStatus}}</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Work Description</label>
                            <div class="border p-3 bg-light">
                                <p>{{JobCardDBdata.work_description}}</p>
                                <!-- <ul>
                                    <li>Engine oil change</li>
                                    <li>Oil filter replacement</li>
                                    <li>Brake inspection and adjustment</li>
                                    <li>Wheel alignment</li>
                                    <li>AC system check</li>
                                </ul> -->
                            </div>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="form-section mt-4">
                        <h5 class="form-section-header">
                            <i class="bi bi-credit-card me-2"></i>Payment
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Total Amount (₹)</label>
                                <input type="text" class="form-control bg-light" value="{{JobCardDBdata.TotalPayent}}"
                                    readonly>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Paid Amount (₹)</label>
                                <input type="text" class="form-control bg-light" value="{{JobCardDBdata.paydPayent}}"
                                    readonly>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Balance Due (₹)</label>
                                <input type="text" class="form-control bg-light" value="{{paymentbalance}}" readonly>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Amount Paid (₹)</label>
                                <input type="number" class="form-control" id="paymentAmountInput" min="0" max=""
                                    step="0.01" value="{{paymentbalance}}" placeholder="Enter amount">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethod">
                                    <option value="upi">UPI</option>
                                    <option value="cash">Cash</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Payment Notes</label>
                            <textarea class="form-control" id="paymentNotes" rows="2"
                                placeholder="Any payment remarks"></textarea>
                        </div>


                        <!-- In the Page Heading section, modify the existing div with buttons -->
                        <div class="d-sm-flex align-items-center justify-content-between mb-4">
                            <h1 class="h3 mb-0 text-gray-800">Job Card Details</h1>
                            <div>
                                <!-- <div class="text-end"> -->
                                <button class="btn btn-success" id="processPaymentBtn">
                                    <i class="bi bi-cash-stack"></i> Process Payment
                                </button>
                                <!-- </div> -->
                                <button class="btn btn-success ms-2" id="generateInvoiceBtn">
                                    <i class="bi bi-file-earmark-text"></i> Generate Invoice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Customer Contact -->
                    <div class="form-section">
                        <h5 class="form-section-header">
                            <i class="bi bi-person-lines-fill me-2"></i>Customer Contact
                        </h5>

                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-telephone me-2"></i>Phone :-
                                {{JobCardDBdata.customer.phone}}</label>
                            <!-- <p class="form-control-plaintext">+1 234 567 890</p> -->
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-envelope me-2"></i>Email :-
                                {{JobCardDBdata.customer.email}}</label>
                            <!-- <p class="form-control-plaintext">john.smith@example.com</p> -->
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-geo-alt me-2"></i>Address :-
                                {{JobCardDBdata.customer.address}}</label>
                            <!-- <p class="form-control-plaintext">
                                123 Main Street<br>
                                New York, NY 10001
                            </p> -->
                        </div>

                        <!-- <div class="text-center mt-4">
                            <button class="btn btn-primary me-2">
                                <i class="bi bi-telephone"></i> Call Customer
                            </button>
                            <button class="btn btn-success">
                                <i class="bi bi-whatsapp"></i> WhatsApp
                            </button>
                        </div> -->
                    </div>

                    <!-- Parts & Materials -->
                    <div class="form-section">
                        <h5 class="form-section-header">
                            <i class="bi bi-box-seam me-2"></i>Parts & Materials
                        </h5>

                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Part</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for i in parts %}
                                    <tr>
                                        <td>{{i.part_obj.ItemName}}</td>
                                        <td>{{i.quantity}}</td>
                                        <td>${{i.part_obj.Price}}</td>
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-secondary">
                                        <td><strong>Total</strong></td>
                                        <td></td>
                                        <td><strong>${{PartsTotal}}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Labor & Pricing -->
                    <div class="form-section">
                        <h5 class="form-section-header">
                            <i class="bi bi-cash-stack me-2"></i>Labor & Pricing
                        </h5>

                        <div class="mb-3">
                            <label class="form-label">Labor Hours :- {{JobCardDBdata.labor_hours}}</label>
                            <!-- <p class="form-control-plaintext">2.5 hours</p> -->
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Hourly Rate :- {{JobCardDBdata.hourly_rate}}</label>
                            <!-- <p class="form-control-plaintext">$50.00</p> -->
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Discount :- {{JobCardDBdata.discount}}</label>
                            <!-- <p class="form-control-plaintext">0%</p> -->
                        </div>

                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Parts Total :- </span>
                                <span>${{PartsTotal}}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Labor Cost:</span>
                                <span>${{labercost}}</span>
                            </div>
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Estimated Total :- {{JobCardDBdata.TotalPayent}}</span>
                                <!-- <span>$305.00</span> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Page Content -->

    </div>
    <!-- End of Content Wrapper -->
    <!-- Invoice Generation Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Generate Invoice</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Invoice Number</label>
                        <input type="text" class="form-control" id="invoiceNumber"
                            value="INV-{{JobCardDBdata.id}}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Invoice Name</label>
                        <input type="text" class="form-control" id="invoiceName"
                            value="INVOICE" >
                    </div>
                    <!-- <div class="mb-3">
                        <label class="form-label">Invoice Date</label>
                        <input type="date" class="form-control" id="invoiceDate" value="{{current_date|date:'Y-m-d'}}">
                    </div> -->
                    <!-- <div class="mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="invoiceNotes" rows="3"></textarea>
                    </div> -->
                    <!-- <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="includeTax" checked>
                        <label class="form-check-label" for="includeTax">Include Tax (18% GST)</label>
                    </div> -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> This will generate a PDF invoice for Job Card
                        #{{JobCardDBdata.id}}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmGenerateInvoice">Generate Invoice</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Payment Confirmation Modal -->
    <div class="modal fade" id="paymentConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Confirm Payment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Confirm payment of <strong>₹<span id="confirmAmount"></span></strong> via <span
                            id="confirmMethod"></span>?</p>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> This will update the payment records for job card
                        <strong>{{JobCardDBdata.id}}</strong>.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPaymentBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Job Card Modal -->
    <div class="modal fade" id="editJobCardModal" tabindex="-1" aria-labelledby="editJobCardModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editJobCardModalLabel">Edit Job Card</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6>Customer Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Customer Name</label>
                                            <input type="text" class="form-control" name="customer_name"
                                                value="{{ JobCardDBdata.customer.name }}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Phone</label>
                                            <input type="text" class="form-control" name="customer_phone"
                                                value="{{ JobCardDBdata.customer.phone }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="customer_email"
                                                value="{{ JobCardDBdata.customer.email }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Address</label>
                                            <textarea class="form-control"
                                                name="customer_address">{{ JobCardDBdata.customer.address }}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Customer Notes</label>
                                            <textarea class="form-control"
                                                name="customer_notes">{{ JobCardDBdata.customer.customernotes }}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6>Vehicle Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Registration No</label>
                                            <input type="text" class="form-control" name="registration_no"
                                                value="{{ JobCardDBdata.vehicle.registration_no }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Model</label>
                                            <input type="text" class="form-control" name="vehicle_model"
                                                value="{{ JobCardDBdata.vehicle.model }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Chassis No</label>
                                            <input type="text" class="form-control" name="chassis_no"
                                                value="{{ JobCardDBdata.vehicle.chassis_no }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Engine No</label>
                                            <input type="text" class="form-control" name="engine_no"
                                                value="{{ JobCardDBdata.vehicle.engine_no }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Petrol Level</label>
                                            <input type="text" class="form-control" name="petrol_level"
                                                value="{{JobCardDBdata.vehicle.petrol_level}}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Vehicle Notes</label>
                                            <textarea class="form-control"
                                                name="vehicle_notes">{{ JobCardDBdata.vehicle.notes }}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Job Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6>Job Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Job Card No</label>
                                            <input type="text" class="form-control" value="{{ JobCardDBdata.id }}"
                                                readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Received Date</label>
                                            <input type="date" class="form-control" name="received_date"
                                                value="{{ JobCardDBdata.received_date|date:'Y-m-d' }}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Delivery Date</label>
                                            <input type="date" class="form-control" name="delivery_date"
                                                value="{{ JobCardDBdata.delivery_date|date:'Y-m-d' }}">
                                        </div>

                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Assigned Staff :- </label>
                                            <span
                                                class="badge bg-warning text-dark">{{JobCardDBdata.assigned_staff.name}}</span>
                                            <select class="form-select" name="assigned_staff">
                                                <option value="{{JobCardDBdata.assigned_staff.id}}" selected>
                                                    {{JobCardDBdata.assigned_staff.name}}
                                                    ({{JobCardDBdata.assigned_staff.position}})</option>
                                                {% for i in worker %}
                                                <option value="{{i.id}}">{{i.name}} ({{i.position}})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Job Status :- </label>
                                            <span class="badge bg-warning text-dark">{{JobCardDBdata.status}}</span>
                                            <select class="form-select" id="jobStatus">
                                                <option value="{{JobCardDBdata.status}}" selected>
                                                    {{JobCardDBdata.status}}</option>
                                                <option value="pending">Pending</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                                <option value="On Hold">On Hold</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Payment Status :- </label>
                                            <span
                                                class="badge bg-warning text-dark">{{JobCardDBdata.paymentStatus}}</span>

                                            <select class="form-select" id="paymentStatus" name="paymentStatus">
                                                <option value="{{JobCardDBdata.paymentStatus}}" selected>
                                                    {{JobCardDBdata.paymentStatus}}</option>
                                                <option value="pending">Pending</option>
                                                <option value="Completed">Completed</option>
                                                <option value="On Hold">On Hold</option>


                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Work Description</label>
                                    <textarea class="form-control" name="work_description"
                                        rows="3">{{ JobCardDBdata.work_description }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Parts & Pricing Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6>Parts & Pricing</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm" id="partsTable">
                                        <thead>
                                            <tr>
                                                <th>Part</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for part in parts %}
                                            <tr data-part-id="{{ part.id }}">
                                                <td>
                                                    <input type="text" class="form-control" name="customer_name"
                                                        value="{{ part.part_obj.ItemName }}" readonly>

                                                </td>
                                                <td><input type="number" class="form-control quantity" name="quantity"
                                                        value="{{ part.quantity }}" min="1" readonly></td>
                                                <td><input type="number" class="form-control price" name="price"
                                                        value="{{ part.part_obj.Price }}" step="0.01" min="0" readonly>
                                                </td>
                                                <td><button type="button" class="btn btn-sm btn-danger remove-part"><i
                                                            class="bi bi-trash"></i></button></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <button type="button" class="btn btn-sm btn-primary" id="addPartBtn">
                                        <i class="bi bi-plus"></i> Add Part
                                    </button>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Labor Hours</label>
                                            <input type="number" step="0.5" class="form-control" name="labor_hours"
                                                value="{{ JobCardDBdata.labor_hours }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hourly Rate</label>
                                            <input type="number" class="form-control" name="hourly_rate"
                                                value="{{ JobCardDBdata.hourly_rate }}">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Discount (%)</label>
                                    <input type="number" class="form-control" name="discount"
                                        value="{{ JobCardDBdata.discount }}" min="0" max="100">
                                </div>


                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" onclick="update_job()">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ready to Leave?</h5>
                    <button class="close" type="button" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                    <a class="btn btn-primary" href="login.html">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Invoice Generation Script
        document.getElementById('generateInvoiceBtn').addEventListener('click', function () {
            const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            invoiceModal.show();
        });

        document.getElementById('confirmGenerateInvoice').addEventListener('click', function () {
            const btn = this;
            const jobCardId = "{{JobCardDBdata.id}}";
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceName = document.getElementById('invoiceName').value;
            // const invoiceDate = document.getElementById('invoiceDate').value;
            // const invoiceNotes = document.getElementById('invoiceNotes').value;
            // const includeTax = document.getElementById('includeTax').checked;

            // Disable button during processing
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

            // Prepare data for the request
            const data = {
                job_card_id: jobCardId,
                invoice_number: invoiceNumber,
                invoiceNam:invoiceName,
                // invoice_date: invoiceDate,
                // notes: invoiceNotes,
                // include_tax: includeTax,
                // customer_id: "{{JobCardDBdata.customer.id}}",
                // vehicle_id: "{{JobCardDBdata.vehicle.id}}"
            };

            // Send request to server to generate invoice
            fetch('/Supervisor/generate_invoice/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Open the generated PDF in a new tab
                        window.open(data.invoice_url, '_blank');

                        // Close the modal
                        const invoiceModal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
                        invoiceModal.hide();
                    } else {
                        throw new Error(data.message || 'Failed to generate invoice');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Invoice generation failed: ' + error.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'Generate Invoice';
                });
        });
    </script>
    <script>
        // Payment Processing Script
        document.addEventListener('DOMContentLoaded', function () {
            // Set max payment amount to balance due
            const balanceDue = parseFloat("{{paymentbalance}}");
            document.getElementById('paymentAmountInput').max = balanceDue;

            // Process Payment Button
            document.getElementById('processPaymentBtn').addEventListener('click', function () {
                const amount = parseFloat(document.getElementById('paymentAmountInput').value);
                const method = document.getElementById('paymentMethod').value;

                // Validate amount
                if (isNaN(amount)) {
                    alert('Please enter a valid amount');
                    return;
                }
                if (amount <= 0) {
                    alert('Payment amount must be greater than ₹0');
                    return;
                }
                if (amount > balanceDue) {
                    alert(`Payment amount cannot exceed balance due of ₹${balanceDue}`);
                    return;
                }

                // Show confirmation modal
                document.getElementById('confirmAmount').textContent = amount.toFixed(2);
                document.getElementById('confirmMethod').textContent = method.charAt(0).toUpperCase() + method.slice(1).replace('_', ' ');

                const paymentModal = new bootstrap.Modal(document.getElementById('paymentConfirmationModal'));
                paymentModal.show();
            });

            // Confirm Payment Button
            document.getElementById('confirmPaymentBtn').addEventListener('click', function () {
                const amount = parseFloat(document.getElementById('paymentAmountInput').value);
                const method = document.getElementById('paymentMethod').value;
                const notes = document.getElementById('paymentNotes').value;
                const jobCardId = "{{JobCardDBdata.id}}";

                // Disable button during processing
                const confirmBtn = document.getElementById('confirmPaymentBtn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

                // Send payment data to server
                fetch('/Supervisor/record_payment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        job_card_id: jobCardId,
                        amount: amount,
                        method: method,
                        notes: notes
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Show success message and reload
                            alert('Payment processed successfully!');
                            // window.location.reload();
                            location.href = location.href;
                        } else {
                            throw new Error(data.message || 'Unknown error occurred');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Payment failed: ' + error.message);
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Confirm';
                    })
                    .finally(() => {
                        // Re-enable button if still on page
                        if (!confirmBtn.disabled) {
                            confirmBtn.innerHTML = 'Confirm';
                        }
                    });
            });
        });
    </script>
    <!-- Custom scripts -->
    <script>
        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('sidebar').classList.toggle('toggled');
            document.getElementById('content').classList.toggle('toggled');
        });



        // Initialize the modal when edit button is clicked
        document.querySelector('.btn-primary[href="#"]').addEventListener('click', function (e) {
            e.preventDefault();
            var editModal = new bootstrap.Modal(document.getElementById('editJobCardModal'));
            editModal.show();
        });

        // Add new part row
        document.getElementById('addPartBtn').addEventListener('click', function () {
            var newRow = document.createElement('tr');
            newRow.innerHTML = `
            <td>
                <select class="form-select part-select">
                    <option value="">Select Part</option>
                    <!-- Parts would be loaded via AJAX -->
                </select>
            </td>
            <td><input type="number" class="form-control quantity" value="1" min="1"></td>
            <td><input type="number" class="form-control price" value="0.00" step="0.01" min="0"></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-part"><i class="bi bi-trash"></i></button></td>
        `;
            document.querySelector('#partsTable tbody').appendChild(newRow);

            // Load parts via AJAX for the new select
            loadPartsForSelect(newRow.querySelector('.part-select'));
        });

        // Remove part row
        // Improved event delegation for remove buttons
        document.querySelector('#partsTable tbody').addEventListener('click', function (e) {
            if (e.target.closest('.remove-part')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                row.remove();

                // Optional: Recalculate totals after deletion
                // calculateTotals();
            }
        });

        function update_job() {
            const formData = new FormData();

            // Basic job card info
            formData.append('job_card_id', '{{ JobCardDBdata.id }}');
            formData.append('status', document.getElementById('jobStatus').value);
            formData.append('received_date', document.querySelector('input[name="received_date"]').value);
            formData.append('delivery_date', document.querySelector('input[name="delivery_date"]').value);
            formData.append('work_description', document.querySelector('textarea[name="work_description"]').value);
            formData.append('labor_hours', document.querySelector('input[name="labor_hours"]').value);
            formData.append('hourly_rate', document.querySelector('input[name="hourly_rate"]').value);
            formData.append('discount', document.querySelector('input[name="discount"]').value);

            const staffSelect = document.querySelector('select[name="assigned_staff"]');
            const selectedStaffOption = staffSelect.options[staffSelect.selectedIndex];
            const staffName = selectedStaffOption.text.split(' (')[0];
            formData.append('assigned_staff_id', staffSelect.value);
            formData.append('assigned_staff_name', staffName);

            const payment = document.querySelector('select[name="paymentStatus"]');
            formData.append('paymentStatus', payment.value);


            // Customer info
            formData.append('customer_name', document.querySelector('input[name="customer_name"]').value);
            formData.append('customer_phone', document.querySelector('input[name="customer_phone"]').value);
            formData.append('customer_email', document.querySelector('input[name="customer_email"]').value);
            formData.append('customer_address', document.querySelector('textarea[name="customer_address"]').value);
            formData.append('customer_notes', document.querySelector('textarea[name="customer_notes"]').value);

            // Vehicle info
            formData.append('registration_no', document.querySelector('input[name="registration_no"]').value);
            formData.append('vehicle_model', document.querySelector('input[name="vehicle_model"]').value);
            formData.append('chassis_no', document.querySelector('input[name="chassis_no"]').value);
            formData.append('engine_no', document.querySelector('input[name="engine_no"]').value);
            formData.append('petrol_level', document.querySelector('input[name="petrol_level"]').value);
            formData.append('vehicle_notes', document.querySelector('textarea[name="vehicle_notes"]').value);



            // Collect parts data - modified to handle both existing and new parts
            // Collect parts data - modified to include IDs for all parts
            const parts = [];
            document.querySelectorAll('#partsTable tbody tr').forEach((row, index) => {
                // For existing parts (read-only rows)
                if (row.querySelector('input[name="customer_name"]')) {
                    const quantity = row.querySelector('input[name="quantity"]').value;
                    const price = row.querySelector('input[name="price"]').value;

                    // Get the part ID from the data attribute (you'll need to add this to your HTML)
                    const partId = row.dataset.partId;

                    parts.push({
                        part_id: partId,  // Include the part ID
                        quantity: quantity,
                        price: price,
                        is_existing: true
                    });
                }
                // For new parts (select rows)
                else if (row.querySelector('.part-select') && row.querySelector('.part-select').value) {
                    const partSelect = row.querySelector('.part-select');
                    const quantityInput = row.querySelector('.quantity');
                    const priceInput = row.querySelector('.price');

                    parts.push({
                        part_id: partSelect.value,
                        quantity: quantityInput.value,
                        price: priceInput.value,
                        is_existing: false
                    });
                }
            });

            formData.append('parts', JSON.stringify(parts));

            // Send data to server via AJAX
            fetch('/Supervisor/update_job_card/', {  // Update with your actual endpoint
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message
                        alert('Job card updated successfully!');
                        // Close modal
                        var editModal = bootstrap.Modal.getInstance(document.getElementById('editJobCardModal'));
                        editModal.hide();
                        // Reload page to see changes
                        // location.reload();
                        location.href = location.href;
                    } else {
                        alert('Error updating job card: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the job card.');
                });

        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to load parts for select dropdown (would need backend API endpoint)
        // Function to load parts for select dropdown
        function loadPartsForSelect(selectElement) {
            fetch('/Supervisor/returnparts')
                .then(response => response.json())
                .then(data => {
                    selectElement.innerHTML = '<option value="">Select Part</option>';
                    data.parts.forEach(part => {
                        const option = document.createElement('option');
                        option.value = part.id;
                        option.textContent = `${part.name} (Stock: ${part.quantity}) - ₹${part.Price.toFixed(2)}`;
                        option.dataset.price = part.Price; // Store price as data attribute
                        selectElement.appendChild(option);
                    });

                    // Add event listener to auto-fill price when part is selected
                    selectElement.addEventListener('change', function () {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption.value) {
                            const priceInput = this.closest('tr').querySelector('.price');
                            priceInput.value = selectedOption.dataset.price;
                        }
                    });
                })
                .catch(error => console.error('Error loading parts:', error));
        }

        // Load parts for existing selects when modal opens
        document.getElementById('editJobCardModal').addEventListener('show.bs.modal', function () {
            document.querySelectorAll('.part-select').forEach(select => {
                if (select.innerHTML.trim() === '<option value="">Select Part</option>') {
                    loadPartsForSelect(select);
                }
            });
        });
    </script>
</body>

</html>